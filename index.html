<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机器学习题库系统 - 增强版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4bb543;
            --danger: #e63946;
            --warning: #ff9e00;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        header p {
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-new {
            background: var(--warning);
            color: white;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 1.4rem;
        }
        
        .card-title i {
            margin-right: 10px;
            font-size: 1.6rem;
        }
        
        .generator-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 768px) {
            .generator-section {
                grid-template-columns: 1fr;
            }
        }
        
        .topic-selector {
            display: flex;
            flex-direction: column;
        }
        
        .topics-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .topic-group {
            background: var(--light);
            padding: 15px;
            border-radius: var(--border-radius);
        }
        
        .topic-group h4 {
            margin-bottom: 10px;
            color: var(--secondary);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 5px;
        }
        
        .topic-checkbox {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .topic-checkbox input {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .prompt-preview textarea {
            width: 100%;
            height: 400px;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            resize: vertical;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 4px 6px rgba(67, 97, 238, 0.3);
        }
        
        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(67, 97, 238, 0.4);
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-secondary {
            background: var(--gray);
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #3d9436;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e68a00;
        }
        
        .buttons-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .question-input textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            resize: vertical;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .quiz-interface {
            display: none;
        }
        
        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: var(--border-radius);
        }
        
        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }
        
        .mode-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .mode-btn i {
            display: block;
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .mode-btn h4 {
            margin-bottom: 5px;
        }
        
        .mode-btn p {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .quiz-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .stat-item i {
            color: var(--primary);
        }
        
        .progress-bar {
            height: 10px;
            background: var(--light-gray);
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress {
            height: 100%;
            background: var(--primary);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .question-card {
            border-left: 5px solid var(--primary);
            padding: 20px;
            margin-bottom: 20px;
            background: var(--light);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .question-card.non-choice {
            border-left-color: var(--secondary);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .question-topic {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-type {
            background: var(--secondary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-score {
            background: var(--accent);
            color: var(--dark);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .mastery-badge {
            background: var(--success);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-text {
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option {
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }
        
        .option:hover {
            border-color: var(--accent);
            background: rgba(76, 201, 240, 0.1);
        }
        
        .option.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .option.correct {
            border-color: var(--success);
            background: rgba(75, 181, 67, 0.1);
        }
        
        .option.incorrect {
            border-color: var(--danger);
            background: rgba(230, 57, 70, 0.1);
        }
        
        .option.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .option-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 30px;
            height: 30px;
            background: var(--light-gray);
            border-radius: 50%;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .option.selected .option-letter {
            background: var(--primary);
            color: white;
        }
        
        .option.correct .option-letter {
            background: var(--success);
            color: white;
        }
        
        .option.incorrect .option-letter {
            background: var(--danger);
            color: white;
        }
        
        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: var(--border-radius);
            display: none;
        }
        
        .feedback.correct {
            background: rgba(75, 181, 67, 0.1);
            border-left: 5px solid var(--success);
        }
        
        .feedback.incorrect {
            background: rgba(230, 57, 70, 0.1);
            border-left: 5px solid var(--danger);
        }
        
        .mastery-control {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
        }
        
        .mastery-control label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .mastery-control input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.3);
        }
        
        .answer-area {
            margin-top: 15px;
        }
        
        .answer-area label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .answer-area textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            resize: vertical;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
            transition: var(--transition);
        }
        
        .answer-area textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }
        
        .reference-answer {
            margin-top: 15px;
            padding: 15px;
            background: rgba(75, 181, 67, 0.1);
            border-left: 5px solid var(--success);
            border-radius: var(--border-radius);
            display: none;
        }
        
        .reference-answer h4 {
            color: var(--success);
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .reference-answer-content {
            color: var(--dark);
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .show-answer-btn {
            margin-top: 10px;
        }
        
        .question-type-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--light);
            border-radius: var(--border-radius);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            border-color: var(--accent);
        }
        
        .tab-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .tab-btn i {
            font-size: 1.1rem;
        }
        
        .tab-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85rem;
        }
        
        .tab-btn.active .tab-count {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .score-display {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-top: 30px;
            display: none;
        }
        
        .score-value {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .score-percentage {
            font-size: 1.5rem;
            color: var(--gray);
            margin-bottom: 20px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat {
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .stat.correct {
            background: rgba(75, 181, 67, 0.1);
            color: var(--success);
        }
        
        .stat.incorrect {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }
        
        .stat.unanswered {
            background: rgba(108, 117, 125, 0.1);
            color: var(--gray);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
        }
        
        .analysis-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--light);
            border-radius: var(--border-radius);
        }
        
        .analysis-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .analysis-title i {
            margin-right: 10px;
        }
        
        .topic-analysis {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .topic-stat {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
        }
        
        .topic-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .topic-name {
            font-weight: 600;
            color: var(--dark);
        }
        
        .topic-accuracy {
            font-weight: bold;
        }
        
        .topic-accuracy.good {
            color: var(--success);
        }
        
        .topic-accuracy.medium {
            color: var(--warning);
        }
        
        .topic-accuracy.poor {
            color: var(--danger);
        }
        
        .topic-bar {
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .topic-progress {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .topic-progress.good {
            background: var(--success);
        }
        
        .topic-progress.medium {
            background: var(--warning);
        }
        
        .topic-progress.poor {
            background: var(--danger);
        }
        
        .ai-prompt-box {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px dashed var(--primary);
            margin-top: 20px;
        }
        
        .ai-prompt-box h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .ai-prompt-box textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            resize: vertical;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .modal-header h3 {
            color: var(--primary);
        }
        
        .close {
            color: var(--gray);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close:hover {
            color: var(--danger);
        }
        
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .wrong-questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: var(--border-radius);
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-controls select {
            padding: 8px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .wrong-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stat-badge {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--gray);
            border: 1px solid var(--light-gray);
        }
        
        .stat-badge i {
            color: var(--danger);
            margin-right: 5px;
        }
        
        .stat-badge strong {
            color: var(--dark);
        }
        
        .wrong-questions-list {
            display: grid;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .wrong-question-item {
            background: white;
            border: 2px solid var(--light-gray);
            border-left: 5px solid var(--danger);
            border-radius: var(--border-radius);
            padding: 20px;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .wrong-question-item:hover {
            border-color: var(--danger);
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.2);
            transform: translateX(5px);
        }
        
        .wrong-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .wrong-item-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .wrong-item-badges .badge {
            margin: 0;
        }
        
        .frequency-badge {
            background: var(--danger);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .date-badge {
            background: var(--gray);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
        }
        
        .wrong-item-question {
            font-size: 1.05rem;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .wrong-item-details {
            background: rgba(230, 57, 70, 0.05);
            padding: 15px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        .wrong-item-details > div {
            margin-bottom: 8px;
        }
        
        .wrong-item-details > div:last-child {
            margin-bottom: 0;
        }
        
        .wrong-item-details strong {
            color: var(--dark);
            margin-right: 8px;
        }
        
        .wrong-answer {
            color: var(--danger);
            font-weight: 600;
        }
        
        .correct-answer {
            color: var(--success);
            font-weight: 600;
        }
        
        .wrong-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 6px 15px;
            font-size: 0.85rem;
            border-radius: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--light-gray);
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .empty-state p {
            font-size: 0.95rem;
        }
        
        @media (max-width: 768px) {
            .wrong-questions-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-controls,
            .wrong-stats {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-brain"></i> 机器学习题库系统<span class="badge badge-new">增强版</span></h1>
            <p>智能错题分析 · 多选题支持 · 复习模式</p>
        </header>
        
        <div class="card">
            <div class="card-title">
                <i class="fas fa-cogs"></i>
                <h2>题目生成器</h2>
            </div>
            
            <div class="generator-section">
                <div class="topic-selector">
                    <div class="topics-container">
                        <div class="topic-group">
                            <h4>非选择题主题 (60分)</h4>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="roc" name="nonChoice" value="ROC曲线" checked>
                                <label for="roc">ROC曲线</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="pr" name="nonChoice" value="Precision-Recall (PR)曲线" checked>
                                <label for="pr">Precision-Recall (PR)曲线</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="svm" name="nonChoice" value="支持向量机 (SVM)" checked>
                                <label for="svm">支持向量机 (SVM)</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="rf" name="nonChoice" value="随机森林 (Random Forest)" checked>
                                <label for="rf">随机森林 (Random Forest)</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="nn" name="nonChoice" value="神经网络 (Neural Network)" checked>
                                <label for="nn">神经网络 (Neural Network)</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="dl" name="nonChoice" value="深度学习 (Deep Learning)" checked>
                                <label for="dl">深度学习 (Deep Learning)</label>
                            </div>
                        </div>
                        
                        <div class="topic-group">
                            <h4>选择题主题 (20-30分)</h4>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="cnn_conv" name="choice" value="CNN相关 - 卷积层作用" checked>
                                <label for="cnn_conv">CNN - 卷积层作用</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="cnn_pool" name="choice" value="CNN相关 - 池化层作用" checked>
                                <label for="cnn_pool">CNN - 池化层作用</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="preprocessing" name="choice" value="数据处理 - 数据预处理" checked>
                                <label for="preprocessing">数据预处理</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="extraction" name="choice" value="数据处理 - 特征提取" checked>
                                <label for="extraction">特征提取</label>
                            </div>
                            <div class="topic-checkbox">
                                <input type="checkbox" id="compression" name="choice" value="数据处理 - 数据压缩" checked>
                                <label for="compression">数据压缩</label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="generatePrompt()">
                        <i class="fas fa-magic"></i> 生成出题Prompt
                    </button>
                </div>
                
                <div class="prompt-preview">
                    <h4>出题Prompt预览</h4>
                    <textarea id="promptOutput" placeholder="点击生成按钮后，这里将显示给AI的出题指令..."></textarea>
                    
                    <div class="buttons-container">
                        <button class="btn btn-secondary" onclick="copyPrompt()">
                            <i class="fas fa-copy"></i> 复制Prompt
                        </button>
                        <button class="btn btn-success" onclick="loadSampleData()">
                            <i class="fas fa-download"></i> 加载示例题目
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">
                <i class="fas fa-file-import"></i>
                <h2>题目导入</h2>
            </div>
            
            <div class="question-input">
                <textarea id="questionInput" placeholder="请将AI生成的题目JSON粘贴到这里..."></textarea>
                
                <div class="buttons-container">
                    <button class="btn" onclick="loadQuestions()">
                        <i class="fas fa-play"></i> 开始刷题
                    </button>
                    <button class="btn btn-warning" onclick="openReviewModal()">
                        <i class="fas fa-redo"></i> 复习模式
                    </button>
                    <button class="btn btn-secondary" onclick="clearQuestions()">
                        <i class="fas fa-trash"></i> 清除内容
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card" id="wrongQuestionsCard" style="display: none;">
            <div class="card-title">
                <i class="fas fa-book-dead"></i>
                <h2>错题本<span class="badge badge-new" id="wrongCountBadge">0</span></h2>
            </div>
            
            <div class="wrong-questions-header">
                <div class="filter-controls">
                    <select id="wrongTopicFilter" onchange="filterWrongQuestions()">
                        <option value="all">全部主题</option>
                    </select>
                    <select id="wrongSortBy" onchange="filterWrongQuestions()">
                        <option value="recent">最近错误</option>
                        <option value="frequency">错误次数</option>
                        <option value="topic">按主题</option>
                    </select>
                </div>
                <div class="wrong-stats">
                    <span class="stat-badge"><i class="fas fa-exclamation-triangle"></i> 总错题: <strong id="totalWrongCount">0</strong></span>
                    <span class="stat-badge"><i class="fas fa-sync"></i> 最薄弱: <strong id="weakestTopic">-</strong></span>
                </div>
            </div>
            
            <div id="wrongQuestionsList" class="wrong-questions-list">
                <!-- 错题列表将在这里动态加载 -->
            </div>
            
            <div class="buttons-container" style="justify-content: center; margin-top: 20px;">
                <button class="btn" onclick="reviewAllWrongQuestions()">
                    <i class="fas fa-play"></i> 复习所有错题
                </button>
                <button class="btn btn-danger" onclick="clearWrongQuestions()">
                    <i class="fas fa-trash-alt"></i> 清空错题本
                </button>
            </div>
        </div>
        
        <div class="card quiz-interface" id="quizInterface">
            <div class="card-title">
                <i class="fas fa-pencil-alt"></i>
                <h2 id="quizModeTitle">刷题模式</h2>
            </div>
            
            <div class="question-type-tabs" id="questionTypeTabs">
                <button class="tab-btn active" id="choiceTab" onclick="switchQuestionType('choice')">
                    <i class="fas fa-list-ul"></i>
                    <span>选择题</span>
                    <span class="tab-count" id="choiceCount">0</span>
                </button>
                <button class="tab-btn" id="nonChoiceTab" onclick="switchQuestionType('nonChoice')">
                    <i class="fas fa-pen"></i>
                    <span>非选择题</span>
                    <span class="tab-count" id="nonChoiceCount">0</span>
                </button>
            </div>
            
            <div class="quiz-header">
                <h3 id="currentTypeTitle">选择题部分</h3>
                <div class="quiz-stats">
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span id="timer">00:00</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-question-circle"></i>
                        <span id="questionCounter">1/10</span>
                    </div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="progress" style="width: 0%"></div>
            </div>
            
            <div id="questionList">
                <!-- 题目将在这里动态加载 -->
            </div>
            
            <div class="navigation">
                <button class="btn btn-secondary" id="prevBtn" onclick="navigateQuestion(-1)">
                    <i class="fas fa-arrow-left"></i> 上一题
                </button>
                <button class="btn" id="nextBtn" onclick="navigateQuestion(1)">
                    下一题 <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <div class="buttons-container" style="justify-content: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="submitAnswers()">
                    <i class="fas fa-check-circle"></i> 提交答案
                </button>
                <button class="btn btn-danger" onclick="exitQuiz()">
                    <i class="fas fa-times-circle"></i> 退出
                </button>
            </div>
        </div>
        
        <div class="score-display" id="scoreDisplay">
            <h2>测试完成!</h2>
            <div class="score-value" id="scoreValue">0/0</div>
            <div class="score-percentage" id="scorePercentage">0%</div>
            
            <div class="stats">
                <div class="stat correct">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">正确</div>
                </div>
                <div class="stat incorrect">
                    <div class="stat-value" id="incorrectCount">0</div>
                    <div class="stat-label">错误</div>
                </div>
                <div class="stat unanswered">
                    <div class="stat-value" id="unansweredCount">0</div>
                    <div class="stat-label">未答</div>
                </div>
            </div>
            
            <div class="analysis-section" id="analysisSection">
                <div class="analysis-title">
                    <i class="fas fa-chart-bar"></i>
                    <span>错题分析</span>
                </div>
                
                <div class="topic-analysis" id="topicAnalysis">
                    <!-- 按主题分析将在这里显示 -->
                </div>
                
                <div class="ai-prompt-box">
                    <h4><i class="fas fa-robot"></i> AI深度分析Prompt</h4>
                    <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 10px;">
                        复制下面的Prompt和错题信息，让AI为你进行深度学习建议分析
                    </p>
                    <textarea id="aiAnalysisPrompt" readonly></textarea>
                    <button class="btn btn-secondary" onclick="copyAIPrompt()" style="margin-top: 10px;">
                        <i class="fas fa-copy"></i> 复制AI分析Prompt
                    </button>
                </div>
            </div>
            
            <div class="buttons-container" style="justify-content: center; margin-top: 30px;">
                <button class="btn" onclick="resetQuiz()">
                    <i class="fas fa-redo"></i> 重新开始
                </button>
                <button class="btn btn-warning" onclick="reviewWrongQuestions()">
                    <i class="fas fa-book-reader"></i> 复习错题
                </button>
            </div>
        </div>
    </div>
    
    <!-- 复习模式选择弹窗 -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-reader"></i> 选择复习模式</h3>
                <span class="close" onclick="closeReviewModal()">&times;</span>
            </div>
            
            <div class="filter-group">
                <label>复习类型</label>
                <select id="reviewType" onchange="updateReviewOptions()">
                    <option value="all">全部题目</option>
                    <option value="wrong">仅错题</option>
                    <option value="topic">按主题复习</option>
                    <option value="unmastered">未掌握题目</option>
                    <option value="random">随机抽题</option>
                </select>
            </div>
            
            <div class="filter-group" id="topicFilter" style="display: none;">
                <label>选择主题</label>
                <div class="checkbox-group" id="topicCheckboxes">
                    <!-- 动态生成主题复选框 -->
                </div>
            </div>
            
            <div class="filter-group" id="randomCount" style="display: none;">
                <label>抽题数量</label>
                <select id="randomNumber">
                    <option value="5">5题</option>
                    <option value="10">10题</option>
                    <option value="15">15题</option>
                    <option value="20">20题</option>
                </select>
            </div>
            
            <div class="buttons-container" style="justify-content: center;">
                <button class="btn" onclick="startReview()">
                    <i class="fas fa-play"></i> 开始复习
                </button>
                <button class="btn btn-secondary" onclick="closeReviewModal()">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">操作成功!</span>
    </div>

    <script>
        // 示例数据（包含单选和多选）
        const sampleQuestions = {
            "nonChoiceQuestions": [
                {
                    "topic": "ROC曲线",
                    "score": 10,
                    "question": "请详细解释ROC曲线的含义，并说明如何使用ROC曲线评估分类模型的性能。在什么情况下AUC值会接近1？",
                    "answer": "ROC曲线（Receiver Operating Characteristic Curve，受试者工作特征曲线）是一种用于评估二分类模型性能的重要工具。\n\n1. ROC曲线的含义：\n   - 横轴：假正率（FPR，False Positive Rate），即实际为负类但被预测为正类的样本比例\n   - 纵轴：真正率（TPR，True Positive Rate，也称为召回率），即实际为正类且被正确预测的样本比例\n   - 曲线绘制：通过改变分类阈值，得到不同的(FPR, TPR)点，连接这些点形成ROC曲线\n\n2. 性能评估：\n   - AUC（Area Under Curve）：ROC曲线下的面积，范围在[0,1]之间\n   - AUC = 0.5：模型性能等同于随机猜测\n   - AUC > 0.5：模型有预测能力\n   - AUC = 1：完美分类器\n\n3. AUC接近1的情况：\n   - 当模型能够在所有阈值下都保持高TPR和低FPR时\n   - 模型对正负样本的区分能力很强\n   - 正负样本的预测分数分布分离度高"
                },
                {
                    "topic": "支持向量机 (SVM)",
                    "score": 12,
                    "question": "解释SVM中核函数的作用，并列举至少三种常用的核函数。为什么在处理非线性可分数据时需要使用核函数？",
                    "answer": "核函数在SVM中的作用和常用类型：\n\n1. 核函数的作用：\n   - 将低维空间中的非线性问题映射到高维空间，使其变成线性可分问题\n   - 通过核技巧（Kernel Trick），避免显式地进行高维空间的计算\n   - 只需计算核函数值K(x_i, x_j)，而不需要知道具体的映射函数φ(x)\n\n2. 常用核函数：\n   - 线性核：K(x, y) = x^T · y\n     适用于线性可分数据，计算简单快速\n   \n   - 多项式核：K(x, y) = (γx^T·y + r)^d\n     可以处理非线性问题，d为多项式次数\n   \n   - 径向基函数核（RBF/高斯核）：K(x, y) = exp(-γ||x-y||²)\n     最常用，适用于各种非线性问题\n   \n   - Sigmoid核：K(x, y) = tanh(γx^T·y + r)\n     模拟神经网络的激活函数\n\n3. 为什么需要核函数处理非线性数据：\n   - 在原始空间中，数据可能不是线性可分的\n   - 通过核函数隐式地将数据映射到高维特征空间\n   - 在高维空间中，原本非线性可分的数据往往变成线性可分\n   - 例如：二维平面上的同心圆数据，映射到三维空间后可以用平面分隔"
                },
                {
                    "topic": "神经网络 (Neural Network)",
                    "score": 15,
                    "question": "描述反向传播算法的基本原理和计算步骤。为什么需要使用链式法则？并解释梯度消失和梯度爆炸问题及其解决方法。",
                    "answer": "反向传播算法详解：\n\n1. 基本原理：\n   - 反向传播是训练神经网络的核心算法\n   - 通过计算损失函数对每个权重的梯度，来更新网络参数\n   - 从输出层开始，逆向传播误差信号到输入层\n\n2. 计算步骤：\n   a) 前向传播：计算每层的激活值和最终输出\n   b) 计算输出层误差：δ^L = ∇_a C ⊙ σ'(z^L)\n   c) 反向传播误差：δ^l = ((w^{l+1})^T δ^{l+1}) ⊙ σ'(z^l)\n   d) 计算梯度：∂C/∂w^l = a^{l-1} δ^l, ∂C/∂b^l = δ^l\n   e) 更新参数：w := w - η∂C/∂w\n\n3. 链式法则的必要性：\n   - 神经网络是多层复合函数\n   - 需要求损失函数对任意层参数的偏导\n   - 链式法则：∂C/∂w^l = ∂C/∂a^L · ∂a^L/∂a^{L-1} · ... · ∂a^{l+1}/∂w^l\n   - 允许误差从后向前逐层传播\n\n4. 梯度消失问题：\n   - 原因：在深层网络中，梯度在反向传播时逐层相乘，可能趋近于0\n   - 影响：浅层网络参数几乎不更新，学习停滞\n   - 解决方法：\n     * 使用ReLU等激活函数（梯度不会衰减）\n     * 批归一化（Batch Normalization）\n     * 残差连接（ResNet）\n     * 使用LSTM/GRU（在RNN中）\n\n5. 梯度爆炸问题：\n   - 原因：梯度在反向传播时指数级增长\n   - 影响：参数更新步长过大，导致发散\n   - 解决方法：\n     * 梯度裁剪（Gradient Clipping）\n     * 权重正则化\n     * 使用较小的学习率\n     * 批归一化"
                }
            ],
            "choiceQuestions": [
                {
                    "topic": "CNN相关 - 卷积层作用",
                    "type": "single",
                    "score": 2,
                    "question": "卷积神经网络(CNN)中，卷积层的主要作用是什么？",
                    "options": [
                        "降低图像分辨率",
                        "提取局部特征",
                        "增加参数数量",
                        "实现分类决策"
                    ],
                    "correctAnswer": 1,
                    "explanation": "卷积层通过卷积核在输入数据上滑动，提取局部特征，如图像中的边缘、纹理等。"
                },
                {
                    "topic": "CNN相关 - 池化层作用",
                    "type": "multiple",
                    "score": 3,
                    "question": "池化层在CNN中的主要作用包括哪些？（多选）",
                    "options": [
                        "降低特征图尺寸",
                        "减少参数数量",
                        "增强模型泛化能力",
                        "直接实现分类",
                        "保持平移不变性",
                        "增加计算复杂度"
                    ],
                    "correctAnswer": [0, 1, 2, 4],
                    "explanation": "池化层主要用于降维、减少参数、防止过拟合，并保持一定的平移不变性。分类通常由全连接层实现，池化会降低而非增加计算复杂度。"
                },
                {
                    "topic": "数据处理 - 数据预处理",
                    "type": "single",
                    "score": 3,
                    "question": "在机器学习项目中，数据预处理的主要目的是什么？",
                    "options": [
                        "增加数据量",
                        "提高数据质量，使数据更适合模型训练",
                        "减少数据存储空间",
                        "可视化数据分布",
                        "加密数据信息"
                    ],
                    "correctAnswer": 1,
                    "explanation": "数据预处理通过清洗、规范化、转换等操作提高数据质量，使其更适合机器学习模型训练。"
                },
                {
                    "topic": "数据处理 - 特征提取",
                    "type": "multiple",
                    "score": 3,
                    "question": "以下哪些是常见的特征提取方法？（多选）",
                    "options": [
                        "主成分分析(PCA)",
                        "线性判别分析(LDA)",
                        "反向传播",
                        "卷积操作",
                        "梯度下降",
                        "独立成分分析(ICA)"
                    ],
                    "correctAnswer": [0, 1, 3, 5],
                    "explanation": "PCA、LDA、卷积操作和ICA都是特征提取方法。反向传播和梯度下降是优化算法，不是特征提取方法。"
                },
                {
                    "topic": "数据处理 - 数据压缩",
                    "type": "single",
                    "score": 2,
                    "question": "以下哪项不是数据压缩在机器学习中的主要作用？",
                    "options": [
                        "减少存储空间",
                        "加快数据处理速度",
                        "提高模型准确性",
                        "降低计算资源需求",
                        "减少数据传输时间"
                    ],
                    "correctAnswer": 2,
                    "explanation": "数据压缩主要目的是减少存储和计算需求，但不直接提高模型准确性，有时甚至可能损失信息。"
                }
            ]
        };

        // 全局变量
        let allQuestions = [];
        let allNonChoiceQuestions = [];
        let currentQuestions = [];
        let currentNonChoiceQuestions = [];
        let userAnswers = [];
        let userNonChoiceAnswers = [];
        let currentQuestionIndex = 0;
        let quizStarted = false;
        let startTime;
        let timerInterval;
        let quizHistory = [];
        let masteredQuestions = new Set();
        let reviewMode = 'normal';
        let wrongQuestionsDB = {}; // 错题数据库: { questionId: { question, wrongCount, lastWrongDate, wrongDates: [] } }
        let currentQuestionType = 'choice'; // 'choice' 或 'nonChoice'

        // 初始化
        function init() {
            generatePrompt();
            loadHistoryFromStorage();
        }

        // 从localStorage加载历史记录
        function loadHistoryFromStorage() {
            const history = localStorage.getItem('quizHistory');
            if (history) {
                quizHistory = JSON.parse(history);
            }
            
            const mastered = localStorage.getItem('masteredQuestions');
            if (mastered) {
                masteredQuestions = new Set(JSON.parse(mastered));
            }
            
            const wrongDB = localStorage.getItem('wrongQuestionsDB');
            if (wrongDB) {
                wrongQuestionsDB = JSON.parse(wrongDB);
                updateWrongQuestionsDisplay();
            }
        }

        // 保存历史记录到localStorage
        function saveHistoryToStorage() {
            localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
            localStorage.setItem('masteredQuestions', JSON.stringify([...masteredQuestions]));
            localStorage.setItem('wrongQuestionsDB', JSON.stringify(wrongQuestionsDB));
        }

        // 生成出题Prompt
        function generatePrompt() {
            const selectedNonChoice = Array.from(document.querySelectorAll('input[name="nonChoice"]:checked'))
                .map(cb => cb.value);
            const selectedChoice = Array.from(document.querySelectorAll('input[name="choice"]:checked'))
                .map(cb => cb.value);

            const prompt = `请基于提供的学习资料，生成一份机器学习考试的题目，要求如下：

一、非选择题部分（共60分）
请针对以下主题出题：${selectedNonChoice.join('、')}
要求：每题应包含清晰的题目描述、分值标注和参考答案

二、选择题部分（共25分）
请针对以下概念出题：${selectedChoice.join('、')}
要求：
- 包含单选题和多选题
- 单选题：4-5个选项
- 多选题：6-8个选项（增加干扰项以提高难度）
- 每题标注题型（单选/多选）、正确答案和详细解析

请以以下JSON格式输出：
{
    "nonChoiceQuestions": [
        {
            "topic": "主题",
            "score": 分值,
            "question": "题目内容",
            "answer": "参考答案"
        }
    ],
    "choiceQuestions": [
        {
            "topic": "主题",
            "type": "single",  // 或 "multiple"
            "score": 分值,
            "question": "题目内容",
            "options": ["选项A", "选项B", "选项C", "选项D", "选项E", "选项F"],
            "correctAnswer": 0,  // 单选题用数字，多选题用数组如 [0, 2, 4]
            "explanation": "解析说明"
        }
    ]
}

注意：
1. 多选题的correctAnswer字段应该是数组，包含所有正确选项的索引
2. 多选题应该有6-8个选项，增加干扰项
3. 题目应该有一定难度，避免过于简单`;

            document.getElementById('promptOutput').value = prompt;
        }

        // 复制Prompt到剪贴板
        function copyPrompt() {
            const promptText = document.getElementById('promptOutput');
            promptText.select();
            document.execCommand('copy');
            showToast('Prompt已复制到剪贴板');
        }

        // 加载示例题目
        function loadSampleData() {
            document.getElementById('questionInput').value = JSON.stringify(sampleQuestions, null, 2);
            showToast('示例题目已加载');
        }

        // 清除题目
        function clearQuestions() {
            document.getElementById('questionInput').value = '';
            showToast('内容已清除');
        }

        // 加载题目并开始刷题
        function loadQuestions(mode = 'normal') {
            try {
                const input = document.getElementById('questionInput').value;
                if (!input.trim()) {
                    showToast('请输入题目JSON数据', 'error');
                    return false;
                }
                
                const questions = JSON.parse(input);
                
                if (!validateQuestions(questions)) {
                    showToast('题目格式错误，请检查JSON结构', 'error');
                    return false;
                }
                
                // 加载选择题
                allQuestions = questions.choiceQuestions || [];
                
                // 加载非选择题
                allNonChoiceQuestions = questions.nonChoiceQuestions || [];
                
                if (allQuestions.length === 0 && allNonChoiceQuestions.length === 0) {
                    showToast('未找到题目数据', 'error');
                    return false;
                }
                
                // 标准化选择题格式
                allQuestions = allQuestions.map((q, index) => {
                    if (!q.type) {
                        q.type = Array.isArray(q.correctAnswer) ? 'multiple' : 'single';
                    }
                    if (!q.id) {
                        q.id = `choice_${Date.now()}_${index}`;
                    }
                    return q;
                });
                
                // 标准化非选择题格式
                allNonChoiceQuestions = allNonChoiceQuestions.map((q, index) => {
                    if (!q.id) {
                        q.id = `nonchoice_${Date.now()}_${index}`;
                    }
                    q.type = 'nonChoice';
                    return q;
                });
                
                reviewMode = mode;
                currentQuestions = [...allQuestions];
                currentNonChoiceQuestions = [...allNonChoiceQuestions];
                userAnswers = new Array(currentQuestions.length).fill(null);
                userNonChoiceAnswers = new Array(currentNonChoiceQuestions.length).fill('');
                
                // 更新题型标签计数
                document.getElementById('choiceCount').textContent = currentQuestions.length;
                document.getElementById('nonChoiceCount').textContent = currentNonChoiceQuestions.length;
                
                // 默认显示选择题
                currentQuestionType = 'choice';
                displayQuestions();
                
                document.getElementById('quizInterface').style.display = 'block';
                document.getElementById('quizModeTitle').textContent = 
                    mode === 'review' ? '复习模式' : '刷题模式';
                
                startQuiz();
                
                const totalCount = currentQuestions.length + currentNonChoiceQuestions.length;
                showToast(`已加载 ${totalCount} 道题目 (选择题${currentQuestions.length}道 + 非选择题${currentNonChoiceQuestions.length}道)`);
                
                // 滚动到刷题界面
                setTimeout(() => {
                    document.getElementById('quizInterface').scrollIntoView({ behavior: 'smooth' });
                }, 100);
                
                return true;
                
            } catch (e) {
                showToast('解析JSON时出错: ' + e.message, 'error');
                return false;
            }
        }

        // 验证题目格式
        function validateQuestions(questions) {
            // 至少要有选择题或非选择题其中一种
            return questions && (
                (questions.choiceQuestions && Array.isArray(questions.choiceQuestions)) ||
                (questions.nonChoiceQuestions && Array.isArray(questions.nonChoiceQuestions))
            );
        }

        // 显示题目
        function displayQuestions() {
            const container = document.getElementById('questionList');
            container.innerHTML = '';
            
            // 控制标签页的显示
            const choiceTab = document.getElementById('choiceTab');
            const nonChoiceTab = document.getElementById('nonChoiceTab');
            const tabsContainer = document.getElementById('questionTypeTabs');
            
            if (currentQuestions.length === 0 && currentNonChoiceQuestions.length === 0) {
                tabsContainer.style.display = 'none';
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>没有题目</h3></div>';
                return;
            }
            
            // 显示标签页容器
            tabsContainer.style.display = 'flex';
            
            // 控制各标签的显示
            if (currentQuestions.length === 0) {
                choiceTab.style.display = 'none';
                if (currentQuestionType === 'choice') {
                    currentQuestionType = 'nonChoice';
                    nonChoiceTab.classList.add('active');
                }
            } else {
                choiceTab.style.display = 'flex';
            }
            
            if (currentNonChoiceQuestions.length === 0) {
                nonChoiceTab.style.display = 'none';
                if (currentQuestionType === 'nonChoice') {
                    currentQuestionType = 'choice';
                    choiceTab.classList.add('active');
                }
            } else {
                nonChoiceTab.style.display = 'flex';
            }
            
            if (currentQuestionType === 'choice') {
                displayChoiceQuestions(container);
            } else {
                displayNonChoiceQuestions(container);
            }
            
            updateProgress();
            updateNavigation();
            updateQuestionCounter();
        }
        
        // 显示选择题
        function displayChoiceQuestions(container) {
            if (currentQuestions.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>没有选择题</h3></div>';
                return;
            }
            
            currentQuestions.forEach((q, index) => {
                const isMultiple = q.type === 'multiple' || Array.isArray(q.correctAnswer);
                const isMastered = masteredQuestions.has(q.id);
                
                let optionsHtml = '<div class="options-container">';
                q.options.forEach((option, optIndex) => {
                    optionsHtml += `
                        <div class="option" data-index="${index}" data-option="${optIndex}" 
                             onclick="selectOption(${index}, ${optIndex}, ${isMultiple})">
                            <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                });
                optionsHtml += '</div>';
                
                const typeLabel = isMultiple ? '多选题' : '单选题';
                const masteredBadge = isMastered ? '<span class="mastery-badge"><i class="fas fa-check"></i> 已掌握</span>' : '';
                
                const feedbackHtml = `
                    <div class="feedback" id="feedback${index}">
                        <strong>正确答案: ${formatCorrectAnswer(q.correctAnswer)}</strong><br>
                        <strong>解析:</strong> ${q.explanation}
                    </div>
                `;
                
                const masteryControl = reviewMode === 'review' ? `
                    <div class="mastery-control">
                        <label>
                            <input type="checkbox" onchange="toggleMastery('${q.id}', this.checked)" 
                                   ${isMastered ? 'checked' : ''}>
                            <span>标记为已掌握</span>
                        </label>
                    </div>
                ` : '';
                
                container.innerHTML += `
                    <div class="question-card ${index === 0 ? 'active' : ''}" id="question${index}" 
                         ${index === 0 ? '' : 'style="display: none;"'}>
                        <div class="question-header">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div class="question-topic">${q.topic}</div>
                                <div class="question-type">${typeLabel}</div>
                                <div class="question-score">${q.score}分</div>
                                ${masteredBadge}
                            </div>
                        </div>
                        <div class="question-text">${index + 1}. ${q.question}${isMultiple ? ' <strong style="color: var(--danger);">[多选]</strong>' : ''}</div>
                        ${optionsHtml}
                        ${feedbackHtml}
                        ${masteryControl}
                    </div>
                `;
            });
        }
        
        // 显示非选择题
        function displayNonChoiceQuestions(container) {
            if (currentNonChoiceQuestions.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>没有非选择题</h3></div>';
                return;
            }
            
            currentNonChoiceQuestions.forEach((q, index) => {
                const isMastered = masteredQuestions.has(q.id);
                const masteredBadge = isMastered ? '<span class="mastery-badge"><i class="fas fa-check"></i> 已掌握</span>' : '';
                
                const masteryControl = reviewMode === 'review' ? `
                    <div class="mastery-control">
                        <label>
                            <input type="checkbox" onchange="toggleMastery('${q.id}', this.checked)" 
                                   ${isMastered ? 'checked' : ''}>
                            <span>标记为已掌握</span>
                        </label>
                    </div>
                ` : '';
                
                container.innerHTML += `
                    <div class="question-card non-choice ${index === 0 ? 'active' : ''}" id="nonChoiceQuestion${index}" 
                         ${index === 0 ? '' : 'style="display: none;"'}>
                        <div class="question-header">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div class="question-topic">${q.topic}</div>
                                <div class="question-type">简答题</div>
                                <div class="question-score">${q.score}分</div>
                                ${masteredBadge}
                            </div>
                        </div>
                        <div class="question-text">${index + 1}. ${q.question}</div>
                        
                        <div class="answer-area">
                            <label>你的答案：</label>
                            <textarea id="nonChoiceAnswer${index}" 
                                      placeholder="请在此输入你的答案..."
                                      oninput="saveNonChoiceAnswer(${index}, this.value)">${userNonChoiceAnswers[index] || ''}</textarea>
                        </div>
                        
                        <button class="btn btn-secondary show-answer-btn" onclick="toggleReferenceAnswer(${index})">
                            <i class="fas fa-eye"></i> 查看参考答案
                        </button>
                        
                        <div class="reference-answer" id="refAnswer${index}">
                            <h4><i class="fas fa-lightbulb"></i> 参考答案</h4>
                            <div class="reference-answer-content">${q.answer}</div>
                        </div>
                        
                        ${masteryControl}
                    </div>
                `;
            });
        }

        // 格式化正确答案显示
        function formatCorrectAnswer(answer) {
            if (Array.isArray(answer)) {
                return answer.map(i => String.fromCharCode(65 + i)).join(', ');
            }
            return String.fromCharCode(65 + answer);
        }

        // 选择选项
        function selectOption(qIndex, optIndex, isMultiple) {
            const question = currentQuestions[qIndex];
            const option = document.querySelector(`.option[data-index="${qIndex}"][data-option="${optIndex}"]`);
            
            if (isMultiple) {
                // 多选题逻辑
                if (!userAnswers[qIndex]) {
                    userAnswers[qIndex] = [];
                }
                
                const answerIndex = userAnswers[qIndex].indexOf(optIndex);
                if (answerIndex > -1) {
                    // 取消选择
                    userAnswers[qIndex].splice(answerIndex, 1);
                    option.classList.remove('selected');
                } else {
                    // 添加选择
                    userAnswers[qIndex].push(optIndex);
                    option.classList.add('selected');
                }
                
                // 如果数组为空，设为null
                if (userAnswers[qIndex].length === 0) {
                    userAnswers[qIndex] = null;
                }
            } else {
                // 单选题逻辑
                const options = document.querySelectorAll(`.option[data-index="${qIndex}"]`);
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                userAnswers[qIndex] = optIndex;
            }
            
            updateProgress();
        }

        // 显示反馈
        function showFeedback(qIndex, userAnswer) {
            const question = currentQuestions[qIndex];
            const feedback = document.getElementById(`feedback${qIndex}`);
            const options = document.querySelectorAll(`.option[data-index="${qIndex}"]`);
            const isMultiple = Array.isArray(question.correctAnswer);
            
            // 禁用所有选项
            options.forEach(opt => {
                opt.classList.add('disabled');
                opt.style.cursor = 'not-allowed';
            });
            
            // 重置所有选项样式
            options.forEach(opt => {
                opt.classList.remove('correct', 'incorrect');
            });
            
            if (isMultiple) {
                // 多选题反馈
                const correctAnswers = question.correctAnswer;
                
                // 标记所有正确答案
                correctAnswers.forEach(answerIndex => {
                    const correctOption = document.querySelector(
                        `.option[data-index="${qIndex}"][data-option="${answerIndex}"]`
                    );
                    correctOption.classList.add('correct');
                });
                
                // 标记用户的错误选择
                if (userAnswer && userAnswer.length > 0) {
                    userAnswer.forEach(answerIndex => {
                        if (!correctAnswers.includes(answerIndex)) {
                            const wrongOption = document.querySelector(
                                `.option[data-index="${qIndex}"][data-option="${answerIndex}"]`
                            );
                            wrongOption.classList.add('incorrect');
                        }
                    });
                }
            } else {
                // 单选题反馈
                const correctOption = document.querySelector(
                    `.option[data-index="${qIndex}"][data-option="${question.correctAnswer}"]`
                );
                correctOption.classList.add('correct');
                
                if (userAnswer !== null && userAnswer !== question.correctAnswer) {
                    const userOption = document.querySelector(
                        `.option[data-index="${qIndex}"][data-option="${userAnswer}"]`
                    );
                    userOption.classList.add('incorrect');
                }
            }
            
            // 显示反馈
            const isCorrect = checkAnswer(question, userAnswer);
            feedback.style.display = 'block';
            feedback.classList.add(isCorrect ? 'correct' : 'incorrect');
        }

        // 检查答案是否正确
        function checkAnswer(question, userAnswer) {
            if (userAnswer === null) return false;
            
            if (Array.isArray(question.correctAnswer)) {
                // 多选题：需要完全匹配
                if (!Array.isArray(userAnswer)) return false;
                if (userAnswer.length !== question.correctAnswer.length) return false;
                
                const sortedUser = [...userAnswer].sort((a, b) => a - b);
                const sortedCorrect = [...question.correctAnswer].sort((a, b) => a - b);
                
                return sortedUser.every((val, index) => val === sortedCorrect[index]);
            } else {
                // 单选题
                return userAnswer === question.correctAnswer;
            }
        }

        // 更新进度条
        function updateProgress() {
            let answeredCount = 0;
            let totalCount = 0;
            
            // 计算选择题进度
            if (currentQuestions.length > 0) {
                answeredCount += userAnswers.filter(answer => answer !== null).length;
                totalCount += currentQuestions.length;
            }
            
            // 计算非选择题进度
            if (currentNonChoiceQuestions.length > 0) {
                answeredCount += userNonChoiceAnswers.filter(answer => answer && answer.trim() !== '').length;
                totalCount += currentNonChoiceQuestions.length;
            }
            
            const progress = totalCount > 0 ? (answeredCount / totalCount) * 100 : 0;
            document.getElementById('progress').style.width = `${progress}%`;
        }

        // 更新题目计数器
        function updateQuestionCounter() {
            const current = currentQuestionIndex + 1;
            const total = currentQuestionType === 'choice' ? currentQuestions.length : currentNonChoiceQuestions.length;
            document.getElementById('questionCounter').textContent = `${current}/${total}`;
        }

        // 更新导航按钮状态
        function updateNavigation() {
            const total = currentQuestionType === 'choice' ? currentQuestions.length : currentNonChoiceQuestions.length;
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === total - 1;
        }

        // 导航题目
        function navigateQuestion(direction) {
            const prefix = currentQuestionType === 'choice' ? 'question' : 'nonChoiceQuestion';
            
            // 隐藏当前题目
            document.getElementById(`${prefix}${currentQuestionIndex}`).style.display = 'none';
            
            // 更新索引
            currentQuestionIndex += direction;
            
            // 显示新题目
            document.getElementById(`${prefix}${currentQuestionIndex}`).style.display = 'block';
            
            updateNavigation();
            updateQuestionCounter();
            
            // 滚动到题目顶部
            document.getElementById('quizInterface').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 切换题型
        function switchQuestionType(type) {
            if (currentQuestionType === type) return;
            
            currentQuestionType = type;
            currentQuestionIndex = 0;
            
            // 更新标签按钮样式
            document.getElementById('choiceTab').classList.toggle('active', type === 'choice');
            document.getElementById('nonChoiceTab').classList.toggle('active', type === 'nonChoice');
            
            // 更新标题
            document.getElementById('currentTypeTitle').textContent = 
                type === 'choice' ? '选择题部分' : '非选择题部分';
            
            // 重新显示题目
            displayQuestions();
        }
        
        // 保存非选择题答案
        function saveNonChoiceAnswer(index, answer) {
            userNonChoiceAnswers[index] = answer;
            updateProgress();
        }
        
        // 切换参考答案显示
        function toggleReferenceAnswer(index) {
            const refAnswer = document.getElementById(`refAnswer${index}`);
            const btn = event.target;
            
            if (refAnswer.style.display === 'none' || !refAnswer.style.display) {
                refAnswer.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏参考答案';
            } else {
                refAnswer.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-eye"></i> 查看参考答案';
            }
        }

        // 开始测验
        function startQuiz() {
            quizStarted = true;
            startTime = new Date();
            currentQuestionIndex = 0;
            
            // 启动计时器
            timerInterval = setInterval(updateTimer, 1000);
        }

        // 更新计时器
        function updateTimer() {
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 提交答案
        function submitAnswers() {
            const unansweredCount = userAnswers.filter(answer => answer === null).length;
            
            if (unansweredCount > 0) {
                if (!confirm(`还有 ${unansweredCount} 道题未作答，确定要提交吗？`)) {
                    return;
                }
            }
            
            // 停止计时器
            clearInterval(timerInterval);
            
            // 计算成绩
            let score = 0;
            let correctCount = 0;
            let incorrectCount = 0;
            let unansweredCountFinal = 0;
            const wrongQuestions = [];
            const topicStats = {};
            const currentDate = new Date().toISOString();
            
            currentQuestions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = checkAnswer(q, userAnswer);
                
                // 初始化主题统计
                if (!topicStats[q.topic]) {
                    topicStats[q.topic] = { total: 0, correct: 0, wrong: 0 };
                }
                topicStats[q.topic].total++;
                
                if (userAnswer === null) {
                    unansweredCountFinal++;
                    topicStats[q.topic].wrong++;
                    wrongQuestions.push({ ...q, index, userAnswer: null, reason: '未作答' });
                    
                    // 记录到错题本
                    addToWrongQuestions(q, null, currentDate);
                } else if (isCorrect) {
                    correctCount++;
                    score += q.score;
                    topicStats[q.topic].correct++;
                } else {
                    incorrectCount++;
                    topicStats[q.topic].wrong++;
                    wrongQuestions.push({ 
                        ...q, 
                        index, 
                        userAnswer, 
                        reason: '答案错误' 
                    });
                    
                    // 记录到错题本
                    addToWrongQuestions(q, userAnswer, currentDate);
                    
                    // 显示错误题目的反馈
                    showFeedback(index, userAnswer);
                }
            });
            
            // 保存到历史记录
            const quizRecord = {
                date: currentDate,
                score,
                correctCount,
                incorrectCount,
                unansweredCount: unansweredCountFinal,
                totalQuestions: currentQuestions.length,
                wrongQuestions,
                topicStats
            };
            quizHistory.push(quizRecord);
            saveHistoryToStorage();
            
            // 更新错题本显示
            updateWrongQuestionsDisplay();
            
            // 显示成绩
            const totalScore = currentQuestions.reduce((sum, q) => sum + q.score, 0);
            const percentage = ((score / totalScore) * 100).toFixed(1);
            
            document.getElementById('scoreValue').textContent = `${score}/${totalScore}`;
            document.getElementById('scorePercentage').textContent = `${percentage}%`;
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            document.getElementById('unansweredCount').textContent = unansweredCountFinal;
            
            // 显示错题分析
            displayTopicAnalysis(topicStats);
            generateAIAnalysisPrompt(wrongQuestions, topicStats, percentage);
            
            document.getElementById('scoreDisplay').style.display = 'block';
            document.getElementById('quizInterface').style.display = 'none';
            
            // 滚动到成绩显示
            setTimeout(() => {
                document.getElementById('scoreDisplay').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // 显示主题分析
        function displayTopicAnalysis(topicStats) {
            const container = document.getElementById('topicAnalysis');
            container.innerHTML = '';
            
            Object.keys(topicStats).forEach(topic => {
                const stats = topicStats[topic];
                const accuracy = ((stats.correct / stats.total) * 100).toFixed(1);
                
                let accuracyClass = 'good';
                if (accuracy < 60) accuracyClass = 'poor';
                else if (accuracy < 80) accuracyClass = 'medium';
                
                container.innerHTML += `
                    <div class="topic-stat">
                        <div class="topic-stat-header">
                            <span class="topic-name">${topic}</span>
                            <span class="topic-accuracy ${accuracyClass}">${accuracy}%</span>
                        </div>
                        <div class="topic-bar">
                            <div class="topic-progress ${accuracyClass}" style="width: ${accuracy}%"></div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">
                            正确: ${stats.correct} / 总计: ${stats.total}
                        </div>
                    </div>
                `;
            });
        }

        // 生成AI分析Prompt
        function generateAIAnalysisPrompt(wrongQuestions, topicStats, percentage) {
            let prompt = `# 机器学习测试错题分析请求\n\n`;
            prompt += `## 测试概况\n`;
            prompt += `- 总得分率: ${percentage}%\n`;
            prompt += `- 错题数量: ${wrongQuestions.length}\n\n`;
            
            prompt += `## 各主题表现\n`;
            Object.keys(topicStats).forEach(topic => {
                const stats = topicStats[topic];
                const accuracy = ((stats.correct / stats.total) * 100).toFixed(1);
                prompt += `- ${topic}: ${accuracy}% (${stats.correct}/${stats.total})\n`;
            });
            
            if (wrongQuestions.length > 0) {
                prompt += `\n## 错题详情\n`;
                wrongQuestions.forEach((q, idx) => {
                    prompt += `\n### 错题 ${idx + 1}: ${q.question}\n`;
                    prompt += `- **主题**: ${q.topic}\n`;
                    prompt += `- **题型**: ${q.type === 'multiple' ? '多选题' : '单选题'}\n`;
                    prompt += `- **正确答案**: ${formatCorrectAnswer(q.correctAnswer)}\n`;
                    
                    if (q.userAnswer === null) {
                        prompt += `- **我的答案**: 未作答\n`;
                    } else {
                        prompt += `- **我的答案**: ${formatCorrectAnswer(q.userAnswer)}\n`;
                    }
                    
                    prompt += `- **解析**: ${q.explanation}\n`;
                });
            }
            
            prompt += `\n## 请帮我分析\n`;
            prompt += `1. 根据错题情况，分析我在哪些知识点上掌握不足\n`;
            prompt += `2. 针对薄弱环节，给出具体的学习建议和复习重点\n`;
            prompt += `3. 推荐相关的学习资源或练习方向\n`;
            prompt += `4. 如果有共同的错误模式，请指出并给出改进建议\n`;
            
            document.getElementById('aiAnalysisPrompt').value = prompt;
        }

        // 复制AI分析Prompt
        function copyAIPrompt() {
            const promptText = document.getElementById('aiAnalysisPrompt');
            promptText.select();
            document.execCommand('copy');
            showToast('AI分析Prompt已复制');
        }

        // 标记掌握状态
        function toggleMastery(questionId, isMastered) {
            if (isMastered) {
                masteredQuestions.add(questionId);
            } else {
                masteredQuestions.delete(questionId);
            }
            saveHistoryToStorage();
            showToast(isMastered ? '已标记为掌握' : '已取消掌握标记');
        }

        // 打开复习模式选择弹窗
        function openReviewModal() {
            // 先尝试加载题目
            if (!loadQuestions('temp')) {
                return;
            }
            
            // 生成主题列表（合并选择题和非选择题的主题）
            const allTopics = [
                ...allQuestions.map(q => q.topic),
                ...allNonChoiceQuestions.map(q => q.topic)
            ];
            const topics = [...new Set(allTopics)];
            const topicCheckboxes = document.getElementById('topicCheckboxes');
            topicCheckboxes.innerHTML = '';
            
            topics.forEach((topic, index) => {
                topicCheckboxes.innerHTML += `
                    <label>
                        <input type="checkbox" value="${topic}" checked>
                        ${topic}
                    </label>
                `;
            });
            
            // 重置表单
            document.getElementById('reviewType').value = 'all';
            updateReviewOptions();
            
            // 显示弹窗
            document.getElementById('reviewModal').style.display = 'block';
            
            // 隐藏临时加载的界面
            document.getElementById('quizInterface').style.display = 'none';
        }

        // 关闭复习模式选择弹窗
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
        }

        // 更新复习选项
        function updateReviewOptions() {
            const reviewType = document.getElementById('reviewType').value;
            
            document.getElementById('topicFilter').style.display = 
                reviewType === 'topic' ? 'block' : 'none';
            document.getElementById('randomCount').style.display = 
                reviewType === 'random' ? 'block' : 'none';
        }

        // 开始复习
        function startReview() {
            const reviewType = document.getElementById('reviewType').value;
            let filteredQuestions = [];
            let filteredNonChoice = [];
            
            switch (reviewType) {
                case 'all':
                    filteredQuestions = [...allQuestions];
                    filteredNonChoice = [...allNonChoiceQuestions];
                    break;
                    
                case 'wrong':
                    // 获取最近一次的错题（仅选择题有错题本功能）
                    if (quizHistory.length > 0) {
                        const lastQuiz = quizHistory[quizHistory.length - 1];
                        const wrongIds = lastQuiz.wrongQuestions.map(q => q.id);
                        filteredQuestions = allQuestions.filter(q => wrongIds.includes(q.id));
                    }
                    if (filteredQuestions.length === 0) {
                        showToast('没有找到错题记录', 'error');
                        return;
                    }
                    break;
                    
                case 'topic':
                    const selectedTopics = Array.from(
                        document.querySelectorAll('#topicCheckboxes input:checked')
                    ).map(cb => cb.value);
                    
                    if (selectedTopics.length === 0) {
                        showToast('请至少选择一个主题', 'error');
                        return;
                    }
                    
                    filteredQuestions = allQuestions.filter(q => 
                        selectedTopics.includes(q.topic)
                    );
                    filteredNonChoice = allNonChoiceQuestions.filter(q => 
                        selectedTopics.includes(q.topic)
                    );
                    break;
                    
                case 'unmastered':
                    filteredQuestions = allQuestions.filter(q => 
                        !masteredQuestions.has(q.id)
                    );
                    filteredNonChoice = allNonChoiceQuestions.filter(q => 
                        !masteredQuestions.has(q.id)
                    );
                    if (filteredQuestions.length === 0 && filteredNonChoice.length === 0) {
                        showToast('所有题目都已掌握！', 'success');
                        return;
                    }
                    break;
                    
                case 'random':
                    const count = parseInt(document.getElementById('randomNumber').value);
                    const allCombined = [...allQuestions, ...allNonChoiceQuestions];
                    const shuffled = allCombined.sort(() => Math.random() - 0.5);
                    const selected = shuffled.slice(0, Math.min(count, shuffled.length));
                    
                    // 分离选择题和非选择题
                    filteredQuestions = selected.filter(q => q.type !== 'nonChoice');
                    filteredNonChoice = selected.filter(q => q.type === 'nonChoice');
                    break;
            }
            
            if (filteredQuestions.length === 0 && filteredNonChoice.length === 0) {
                showToast('没有符合条件的题目', 'error');
                return;
            }
            
            currentQuestions = filteredQuestions;
            currentNonChoiceQuestions = filteredNonChoice;
            userAnswers = new Array(currentQuestions.length).fill(null);
            userNonChoiceAnswers = new Array(currentNonChoiceQuestions.length).fill('');
            reviewMode = 'review';
            currentQuestionType = 'choice';
            
            // 更新题型标签计数
            document.getElementById('choiceCount').textContent = currentQuestions.length;
            document.getElementById('nonChoiceCount').textContent = currentNonChoiceQuestions.length;
            
            // 如果没有选择题，默认显示非选择题
            if (currentQuestions.length === 0 && currentNonChoiceQuestions.length > 0) {
                currentQuestionType = 'nonChoice';
                document.getElementById('choiceTab').classList.remove('active');
                document.getElementById('nonChoiceTab').classList.add('active');
            }
            
            closeReviewModal();
            displayQuestions();
            document.getElementById('quizInterface').style.display = 'block';
            document.getElementById('quizModeTitle').textContent = '复习模式';
            
            startQuiz();
            const totalCount = currentQuestions.length + currentNonChoiceQuestions.length;
            showToast(`开始复习 ${totalCount} 道题目`);
            
            setTimeout(() => {
                document.getElementById('quizInterface').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // 复习错题（从结果页面）
        function reviewWrongQuestions() {
            if (quizHistory.length === 0) {
                showToast('没有历史记录', 'error');
                return;
            }
            
            const lastQuiz = quizHistory[quizHistory.length - 1];
            if (lastQuiz.wrongQuestions.length === 0) {
                showToast('上次测试全部正确，无需复习！', 'success');
                return;
            }
            
            const wrongIds = lastQuiz.wrongQuestions.map(q => q.id);
            currentQuestions = allQuestions.filter(q => wrongIds.includes(q.id));
            userAnswers = new Array(currentQuestions.length).fill(null);
            reviewMode = 'review';
            
            displayQuestions();
            document.getElementById('scoreDisplay').style.display = 'none';
            document.getElementById('quizInterface').style.display = 'block';
            document.getElementById('quizModeTitle').textContent = '错题复习';
            
            startQuiz();
            showToast(`开始复习 ${currentQuestions.length} 道错题`);
            
            setTimeout(() => {
                document.getElementById('quizInterface').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // 退出测验
        function exitQuiz() {
            if (confirm('确定要退出当前测验吗？未提交的答案将丢失。')) {
                resetQuiz();
            }
        }

        // 重置测验
        function resetQuiz() {
            currentQuestions = [];
            currentNonChoiceQuestions = [];
            userAnswers = [];
            userNonChoiceAnswers = [];
            currentQuestionIndex = 0;
            quizStarted = false;
            reviewMode = 'normal';
            currentQuestionType = 'choice';
            
            document.getElementById('quizInterface').style.display = 'none';
            document.getElementById('scoreDisplay').style.display = 'none';
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // 滚动回顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            if (type === 'error') {
                toast.style.background = 'var(--danger)';
                toast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else {
                toast.style.background = 'var(--success)';
                toast.querySelector('i').className = 'fas fa-check-circle';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 点击弹窗外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('reviewModal');
            if (event.target === modal) {
                closeReviewModal();
            }
        }
        
        // ========== 错题本功能 ==========
        
        // 添加到错题本
        function addToWrongQuestions(question, userAnswer, date) {
            const qId = question.id;
            
            if (!wrongQuestionsDB[qId]) {
                wrongQuestionsDB[qId] = {
                    question: question,
                    wrongCount: 0,
                    firstWrongDate: date,
                    lastWrongDate: date,
                    wrongDates: [],
                    userAnswers: []
                };
            }
            
            wrongQuestionsDB[qId].wrongCount++;
            wrongQuestionsDB[qId].lastWrongDate = date;
            wrongQuestionsDB[qId].wrongDates.push(date);
            wrongQuestionsDB[qId].userAnswers.push(userAnswer);
            
            saveHistoryToStorage();
        }
        
        // 更新错题本显示
        function updateWrongQuestionsDisplay() {
            const wrongCount = Object.keys(wrongQuestionsDB).length;
            
            // 更新错题计数徽章
            document.getElementById('wrongCountBadge').textContent = wrongCount;
            
            // 显示/隐藏错题本卡片
            if (wrongCount > 0) {
                document.getElementById('wrongQuestionsCard').style.display = 'block';
            }
            
            // 更新统计信息
            document.getElementById('totalWrongCount').textContent = wrongCount;
            
            // 找出最薄弱的主题
            const topicErrorCount = {};
            Object.values(wrongQuestionsDB).forEach(item => {
                const topic = item.question.topic;
                topicErrorCount[topic] = (topicErrorCount[topic] || 0) + item.wrongCount;
            });
            
            let weakestTopic = '-';
            let maxErrors = 0;
            for (const [topic, count] of Object.entries(topicErrorCount)) {
                if (count > maxErrors) {
                    maxErrors = count;
                    weakestTopic = topic;
                }
            }
            document.getElementById('weakestTopic').textContent = weakestTopic;
            
            // 更新主题筛选器
            const topics = [...new Set(Object.values(wrongQuestionsDB).map(item => item.question.topic))];
            const topicFilter = document.getElementById('wrongTopicFilter');
            topicFilter.innerHTML = '<option value="all">全部主题</option>';
            topics.forEach(topic => {
                topicFilter.innerHTML += `<option value="${topic}">${topic}</option>`;
            });
            
            // 显示错题列表
            filterWrongQuestions();
        }
        
        // 过滤和显示错题
        function filterWrongQuestions() {
            const topicFilter = document.getElementById('wrongTopicFilter').value;
            const sortBy = document.getElementById('wrongSortBy').value;
            const container = document.getElementById('wrongQuestionsList');
            
            // 获取所有错题
            let wrongItems = Object.entries(wrongQuestionsDB).map(([id, data]) => ({
                id,
                ...data
            }));
            
            // 按主题筛选
            if (topicFilter !== 'all') {
                wrongItems = wrongItems.filter(item => item.question.topic === topicFilter);
            }
            
            // 排序
            switch (sortBy) {
                case 'recent':
                    wrongItems.sort((a, b) => new Date(b.lastWrongDate) - new Date(a.lastWrongDate));
                    break;
                case 'frequency':
                    wrongItems.sort((a, b) => b.wrongCount - a.wrongCount);
                    break;
                case 'topic':
                    wrongItems.sort((a, b) => a.question.topic.localeCompare(b.question.topic));
                    break;
            }
            
            // 显示错题
            if (wrongItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <h3>太棒了！</h3>
                        <p>当前筛选条件下没有错题</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            wrongItems.forEach(item => {
                const q = item.question;
                const isMultiple = q.type === 'multiple' || Array.isArray(q.correctAnswer);
                const typeLabel = isMultiple ? '多选题' : '单选题';
                const lastAnswer = item.userAnswers[item.userAnswers.length - 1];
                const lastDate = new Date(item.lastWrongDate);
                const dateStr = `${lastDate.getMonth() + 1}/${lastDate.getDate()}`;
                
                let userAnswerStr = '未作答';
                if (lastAnswer !== null) {
                    userAnswerStr = formatCorrectAnswer(lastAnswer);
                }
                
                const itemHtml = `
                    <div class="wrong-question-item" onclick="reviewSingleWrongQuestion('${item.id}')">
                        <div class="wrong-item-header">
                            <div class="wrong-item-badges">
                                <span class="question-topic">${q.topic}</span>
                                <span class="question-type">${typeLabel}</span>
                                <span class="question-score">${q.score}分</span>
                            </div>
                            <div class="wrong-item-badges">
                                <span class="frequency-badge">
                                    <i class="fas fa-times"></i> 错${item.wrongCount}次
                                </span>
                                <span class="date-badge">${dateStr}</span>
                            </div>
                        </div>
                        
                        <div class="wrong-item-question">
                            ${q.question}
                        </div>
                        
                        <div class="wrong-item-details">
                            <div>
                                <strong>正确答案:</strong>
                                <span class="correct-answer">${formatCorrectAnswer(q.correctAnswer)}</span>
                            </div>
                            <div>
                                <strong>你的答案:</strong>
                                <span class="wrong-answer">${userAnswerStr}</span>
                            </div>
                            <div>
                                <strong>解析:</strong>
                                <span>${q.explanation}</span>
                            </div>
                        </div>
                        
                        <div class="wrong-item-actions" onclick="event.stopPropagation();">
                            <button class="btn btn-small" onclick="reviewSingleWrongQuestion('${item.id}')">
                                <i class="fas fa-play"></i> 重做
                            </button>
                            <button class="btn btn-small btn-success" onclick="removeFromWrongQuestions('${item.id}')">
                                <i class="fas fa-check"></i> 已掌握
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteFromWrongQuestions('${item.id}')">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML += itemHtml;
            });
        }
        
        // 复习所有错题
        function reviewAllWrongQuestions() {
            if (Object.keys(wrongQuestionsDB).length === 0) {
                showToast('错题本是空的', 'error');
                return;
            }
            
            const wrongQIds = Object.keys(wrongQuestionsDB);
            
            // 从allQuestions中找出这些题目
            const questionsToReview = [];
            wrongQIds.forEach(qId => {
                const wrongItem = wrongQuestionsDB[qId];
                questionsToReview.push(wrongItem.question);
            });
            
            if (questionsToReview.length === 0) {
                showToast('无法找到错题对应的题目', 'error');
                return;
            }
            
            currentQuestions = questionsToReview;
            userAnswers = new Array(currentQuestions.length).fill(null);
            reviewMode = 'review';
            
            displayQuestions();
            document.getElementById('wrongQuestionsCard').style.display = 'none';
            document.getElementById('quizInterface').style.display = 'block';
            document.getElementById('quizModeTitle').textContent = '错题复习';
            
            startQuiz();
            showToast(`开始复习 ${currentQuestions.length} 道错题`);
            
            setTimeout(() => {
                document.getElementById('quizInterface').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
        
        // 复习单个错题
        function reviewSingleWrongQuestion(questionId) {
            const wrongItem = wrongQuestionsDB[questionId];
            if (!wrongItem) {
                showToast('题目不存在', 'error');
                return;
            }
            
            currentQuestions = [wrongItem.question];
            userAnswers = [null];
            reviewMode = 'review';
            
            displayQuestions();
            document.getElementById('wrongQuestionsCard').style.display = 'none';
            document.getElementById('quizInterface').style.display = 'block';
            document.getElementById('quizModeTitle').textContent = '单题复习';
            
            startQuiz();
            
            setTimeout(() => {
                document.getElementById('quizInterface').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
        
        // 从错题本移除（标记为已掌握）
        function removeFromWrongQuestions(questionId) {
            if (confirm('确定已掌握这道题吗？将从错题本中移除。')) {
                const wrongItem = wrongQuestionsDB[questionId];
                if (wrongItem) {
                    // 标记为已掌握
                    masteredQuestions.add(questionId);
                }
                
                delete wrongQuestionsDB[questionId];
                saveHistoryToStorage();
                updateWrongQuestionsDisplay();
                showToast('已从错题本移除');
            }
        }
        
        // 删除错题
        function deleteFromWrongQuestions(questionId) {
            if (confirm('确定要删除这道错题记录吗？')) {
                delete wrongQuestionsDB[questionId];
                saveHistoryToStorage();
                updateWrongQuestionsDisplay();
                showToast('已删除');
            }
        }
        
        // 清空错题本
        function clearWrongQuestions() {
            if (confirm('确定要清空整个错题本吗？此操作不可恢复！')) {
                wrongQuestionsDB = {};
                saveHistoryToStorage();
                updateWrongQuestionsDisplay();
                document.getElementById('wrongQuestionsCard').style.display = 'none';
                showToast('错题本已清空');
            }
        }

        // 初始化
        window.onload = init;
    </script>
</body>
</html>
